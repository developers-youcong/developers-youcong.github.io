---
title: 微服务内部通信之白名单
date: 2020-08-23 11:37:51
tags: "SpringBoot"
---

微服务通信的方式有很多，有的用Socket，也有用一些HTTP客户端工具类，还有的有现成的组件如SpringCloud Open-Feign等。

这些共同点都是通信。

不同服务之间的通信涉及很多方面，比分说内网访问，外网不能访问等。

那么微服务如何实现内部通信呢(这里说的是内网通信，外网不能访问)？
<!--more-->
核心代码如下(采用拦截器机制):
代码中的if-else那段代码可以放在数据库，也可以存NoSQL或者配置文件之类的。
```
public class IPInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {


        String ip = IpUtils.getIpAddr(ServletUtils.getRequest());

        if ("127.0.0.1".equals(ip)) {
            System.out.println("内部IP放行");
            return true;
        } else {
            System.out.println("外部IP禁止访问");
            JSONObject jsonObject = new JSONObject();
            jsonObject.put("code", "403");
            jsonObject.put("msg", "Not Allowed");

            response.getWriter().append(jsonObject.toJSONString());
            return false;
        }

    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {

    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {

    }
}


```

采用拦截器机制后，对应的feign组件URL指向改为如下即可(主要是@FeignClient属性中的url):
```
@FeignClient(contextId = "userApiService", value = ServiceNameConstants.BLOG_SERVICE, url = "http://127.0.0.1:2020")
@RestController
public interface UserApiService {

    @GetMapping("/blog_user/list")
    String queryUserList();
}

```